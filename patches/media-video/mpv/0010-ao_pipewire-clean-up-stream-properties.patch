From b6c24447729bd55d88d7c10baf60ec87e6711545 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Thomas=20Wei=C3=9Fschuh?= <thomas@t-8ch.de>
Date: Fri, 17 Dec 2021 19:00:28 +0100
Subject: [PATCH 10/11] ao_pipewire: clean up stream properties

---
 audio/out/ao_pipewire.c | 36 +++++++++++++++++++-----------------
 1 file changed, 19 insertions(+), 17 deletions(-)

diff --git a/audio/out/ao_pipewire.c b/audio/out/ao_pipewire.c
index ca887514c7..16a3eebbfa 100644
--- a/audio/out/ao_pipewire.c
+++ b/audio/out/ao_pipewire.c
@@ -199,8 +199,23 @@ static int init(struct ao *ao)
     uint8_t buffer[1024];
     struct spa_pod_builder b = SPA_POD_BUILDER_INIT(buffer, sizeof(buffer));
     const struct spa_pod *params[1];
-    char latency_str[64];
-    char samplerate_str[8];
+    struct pw_properties *props = pw_properties_new(
+        PW_KEY_MEDIA_TYPE, "Audio",
+        PW_KEY_MEDIA_CATEGORY, "Playback",
+        PW_KEY_MEDIA_ROLE, "Music",
+        PW_KEY_NODE_NAME, ao->client_name,
+        PW_KEY_NODE_DESCRIPTION, ao->client_name,
+        PW_KEY_APP_NAME, ao->client_name,
+        PW_KEY_APP_ID, ao->client_name,
+        PW_KEY_APP_ICON_NAME, ao->client_name,
+        PW_KEY_NODE_ALWAYS_PROCESS, "true",
+        NULL
+    );
+
+    ao->device_buffer = p->buffer_samples;
+
+    pw_properties_setf(props, PW_KEY_NODE_LATENCY, "%d/%d", ao->device_buffer, ao->samplerate);
+    pw_properties_setf(props, PW_KEY_NODE_RATE, "1/%d", ao->samplerate);
 
     enum spa_audio_format spa_format = af_fmt_to_pw(ao->format);
     if (spa_format == SPA_AUDIO_FORMAT_UNKNOWN) {
@@ -227,10 +242,6 @@ static int init(struct ao *ao)
         ao->sstride = ao->channels.num * af_fmt_to_bytes(ao->format);
     }
 
-    ao->device_buffer = p->buffer_samples;
-    snprintf(latency_str, sizeof(latency_str), "%d/%d", ao->device_buffer, ao->samplerate);
-    snprintf(samplerate_str, sizeof(samplerate_str), "1/%d", ao->samplerate);
-
     pw_init(NULL, NULL);
 
     p->loop = pw_thread_loop_new("ao-pipewire", NULL);
@@ -240,17 +251,7 @@ static int init(struct ao *ao)
     p->stream = pw_stream_new_simple(
                     pw_thread_loop_get_loop(p->loop),
                     "audio-src",
-                    pw_properties_new(
-                        PW_KEY_MEDIA_TYPE, "Audio",
-                        PW_KEY_MEDIA_CATEGORY, "Playback",
-                        PW_KEY_MEDIA_ROLE, "Music",
-                        PW_KEY_NODE_NAME, ao->client_name,
-                        PW_KEY_APP_NAME, ao->client_name,
-                        PW_KEY_APP_ID, ao->client_name,
-                        PW_KEY_APP_ICON_NAME, ao->client_name,
-                        PW_KEY_NODE_LATENCY, latency_str,
-                        PW_KEY_NODE_RATE, samplerate_str,
-                        NULL),
+                    props,
                     &stream_events,
                     ao);
     if (p->stream == NULL)
@@ -260,6 +261,7 @@ static int init(struct ao *ao)
                     PW_DIRECTION_OUTPUT,
                     PW_ID_ANY,
                     PW_STREAM_FLAG_AUTOCONNECT |
+                    PW_STREAM_FLAG_INACTIVE |
                     PW_STREAM_FLAG_MAP_BUFFERS |
                     PW_STREAM_FLAG_RT_PROCESS,
                     params, 1) < 0)
-- 
2.34.1

